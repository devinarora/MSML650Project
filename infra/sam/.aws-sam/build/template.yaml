AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: DSALTA Blog API using Cognito Auth + existing DynamoDB table "posts"
Parameters:
  UserPoolId:
    Type: String
    Default: us-east-2_gbq4DlI0c
  TableName:
    Type: String
    Default: posts
Globals:
  Function:
    Runtime: nodejs18.x
    MemorySize: 256
    Timeout: 10
    Environment:
      Variables:
        TABLE_NAME:
          Ref: TableName
Resources:
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowOrigins:
        - '*'
        AllowMethods:
        - '*'
        AllowHeaders:
        - '*'
      Auth:
        Authorizers:
          CognitoAuth:
            IdentitySource: $request.header.Authorization
            JwtConfiguration:
              issuer:
                Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${UserPoolId}
        DefaultAuthorizer: CognitoAuth
  CreatePostFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CreatePostFn
      Handler: posts/createPost.handler
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
          - dynamodb:Scan
          Resource:
            Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TableName}
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/posts
            Method: POST
    Metadata:
      SamResourceId: CreatePostFn
  ListMyPostsFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ListMyPostsFn
      Handler: posts/listMyPosts.handler
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
          - dynamodb:Scan
          Resource:
            Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TableName}
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/posts
            Method: GET
    Metadata:
      SamResourceId: ListMyPostsFn
  UpdatePostFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UpdatePostFn
      Handler: posts/updatePost.handler
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
          - dynamodb:Scan
          Resource:
            Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TableName}
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/posts/{id}
            Method: PUT
    Metadata:
      SamResourceId: UpdatePostFn
  DeletePostFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DeletePostFn
      Handler: posts/deletePost.handler
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
          - dynamodb:Query
          - dynamodb:Scan
          Resource:
            Fn::Sub: arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${TableName}
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: HttpApi
            Path: /api/posts/{id}
            Method: DELETE
    Metadata:
      SamResourceId: DeletePostFn
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com
